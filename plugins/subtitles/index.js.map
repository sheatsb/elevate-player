{"version":3,"file":"index.js","sources":["../../../source/Plugin/Subtitles/SubtitleSettingMenuItem.js","../../../source/Plugin/Subtitles/Subtitles.js"],"sourcesContent":["import videojs from 'video.js';\n\nconst SettingOptionItem = videojs.getComponent('SettingOptionItem');\n\nclass SubtitleSettingMenuItem extends SettingOptionItem {\n  constructor(player, options) {\n    super(player, {\n      ...options,\n      name: 'SubtitleSettingMenuItem',\n      label: 'Subtitles',\n      icon: 'vjs-icon-subtitles',\n      entries: player.options_.subtitles || []\n    });\n\n    this.addClass('vjs-setting-subtitles');\n\n    player.on('subtitles', (_, subtitles) => {\n      let close = true;\n\n      const entries = subtitles.map((val, index) => {\n        close = !close || !val.default;\n\n        return {\n          ...val,\n          value: index\n        };\n      });\n\n      this.setEntries([\n        ...entries,\n        {\n          label: 'Close Subtitles',\n          value: -1,\n          default: close\n        }\n      ]);\n\n      this.show();\n    });\n\n    player.on('subtitlechange', (_, { index }) => {\n      if (index === -1) {\n        // close subtitles\n        index = this.entries.length - 1;\n      }\n\n      this.select(index);\n      this.update(index);\n    });\n  }\n\n  onChange({ value }) {\n    this.player_.subtitles().pick(value);\n  }\n}\n\nvideojs\n  .getComponent('SettingMenuButton')\n  .prototype.options_.entries.push('SubtitleSettingMenuItem');\n\nvideojs.registerComponent('SubtitleSettingMenuItem', SubtitleSettingMenuItem);\n\nexport default SubtitleSettingMenuItem;\n","import videojs from 'video.js';\n\nimport './SubtitleSettingMenuItem';\nimport './Subtitles.scss';\n\nclass subtitles extends videojs.getPlugin('plugin') {\n  constructor(player, options) {\n    super(player, options);\n\n    this.flag = null;\n    this.track = null;\n\n    let timeout;\n    const handleSubtitleChangeEvent = () => {\n      clearTimeout(timeout);\n\n      const subtitles = this.values();\n      const currentSubtitle = subtitles.find(t => t.mode === 'showing') || {};\n      const newFlag = currentSubtitle.label || currentSubtitle.id || -1;\n\n      // multiple `change` event will reveiced when subtitles changed ( depends on number of subtitles or browser ? )\n      // so that timeout is used to make sure `subtitlechange` event emit once;\n      timeout = setTimeout(() => {\n        if (this.flag !== newFlag) {\n          this.flag = newFlag;\n\n          player.trigger('subtitlechange', {\n            index: subtitles.indexOf(currentSubtitle),\n            label: currentSubtitle.label || ''\n          });\n        }\n      }, 10);\n    };\n\n    player.textTracks().on('change', handleSubtitleChangeEvent);\n    player.on('dispose', () => {\n      player.textTracks().off('change', handleSubtitleChangeEvent);\n    });\n  }\n\n  values() {\n    const tracks = this.player.textTracks();\n    const subtitles = [];\n\n    for (let i = 0; i < tracks.length; i++) {\n      if (tracks[i].kind === 'subtitles') {\n        subtitles.push(tracks[i]);\n      }\n    }\n\n    return subtitles;\n  }\n\n  load(subtitles_ = []) {\n    const { player } = this;\n\n    if (subtitles_ && subtitles_.length) {\n      this.remove();\n\n      let index = -1;\n      const trackEls = [];\n      const subtitles = subtitles_.map((s, i) => {\n        const subtitle = Object.assign({}, s);\n        const manualCleanup = true;\n\n        // set default to false, otherwise subtitle will reset to the default subtitle\n        // when user switch quality with quality plugin\n        const trackEl = player.addRemoteTextTrack(\n          {\n            ...subtitle,\n            default: false\n          },\n          manualCleanup\n        );\n\n        trackEl.track.mode = 'hidden';\n\n        trackEls.push(trackEl);\n\n        if (index === -1 && subtitle.default === true) {\n          index = i;\n        } else {\n          subtitle.default = false;\n        }\n\n        return subtitle;\n      });\n\n      if (index !== -1) {\n        this.flag = subtitles[index].label;\n        this.track = trackEls[index].track;\n        this.track.mode = 'showing';\n      }\n\n      player.trigger('subtitles', subtitles);\n    }\n\n    return this;\n  }\n\n  remove() {\n    this.values().forEach(track => {\n      this.player.removeRemoteTextTrack(track);\n    });\n\n    return this;\n  }\n\n  pick(index) {\n    const subtitles = this.values();\n    const newTrack = subtitles[index];\n\n    if (newTrack) {\n      if (this.track) {\n        this.track.mode = 'disabled';\n      }\n      this.track = newTrack;\n      this.track.mode = 'showing';\n    } else if (this.track) {\n      this.track.mode = 'disabled';\n    }\n\n    return this;\n  }\n}\n\nvideojs.hook('setup', vjsPlayer => {\n  vjsPlayer.ready(() => {\n    const { subtitles } = vjsPlayer.options_;\n    subtitles && subtitles.length && vjsPlayer.subtitles().load(subtitles);\n  });\n});\n\nvideojs.registerPlugin('subtitles', subtitles);\n"],"names":["SettingOptionItem","videojs","getComponent","SubtitleSettingMenuItem","player","options","name","label","icon","entries","options_","subtitles","addClass","on","_","close","map","val","index","value","setEntries","show","length","select","update","onChange","player_","pick","prototype","push","registerComponent","flag","track","timeout","handleSubtitleChangeEvent","clearTimeout","values","currentSubtitle","find","t","mode","newFlag","id","setTimeout","trigger","indexOf","textTracks","off","tracks","i","kind","load","subtitles_","remove","trackEls","s","subtitle","Object","assign","manualCleanup","trackEl","addRemoteTextTrack","forEach","removeRemoteTextTrack","newTrack","getPlugin","hook","vjsPlayer","ready","registerPlugin"],"mappings":"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"}